<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Sukari Game – Login & Register</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background: radial-gradient(circle, #000000, #0f0f0f);
      color: #00ffcc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    .container {
      background: rgba(25, 25, 25, 0.95);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 20px #00ffcc;
      width: 350px;
      text-align: center;
      margin-bottom: 20px;
    }
    input, button {
      width: 90%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      color: #00ffcc;
      background: #222;
      border: 1px solid #00ffcc;
    }
    button {
      background: #00ffcc;
      color: #0f0f0f;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #00e6b8;
    }
    .error {
      color: #ff4444;
      margin-top: 10px;
      min-height: 18px;
    }
    .success {
      color: #44ff44;
      margin-top: 10px;
      min-height: 18px;
    }
  </style>
</head>
<body>

  <div class="container" id="login-register-container">
    <h2>Employee Dashboard</h2>
    <button onclick="showLogin()">Connexion</button>
    <button onclick="showRegister()">Create an Account</button>
  </div>

  <div class="container" id="login-form" style="display:none;">
    <h3>Connexion</h3>
    <input type="text" id="login-id" placeholder="Employee ID" autocomplete="off" />
    <input type="password" id="login-password" placeholder="Mot de passe" autocomplete="off" />
    <button onclick="login()">Se connecter</button>
    <div id="login-message" class="error"></div>
    <button onclick="backToMenu()">Retour</button>
  </div>

  <div class="container" id="register-form" style="display:none;">
    <h3>Créer / Mettre à jour un compte</h3>
    <input type="text" id="register-id" placeholder="Employee ID" autocomplete="off" />
    <input type="password" id="register-password" placeholder="Mot de passe" autocomplete="off" />
    <button onclick="register()">Enregistrer</button>
    <div id="register-message" class="error"></div>
    <button onclick="backToMenu()">Retour</button>
  </div>

  <div class="container" id="dashboard" style="display:none;">
    <h3>Bienvenue, <span id="user-id-display"></span></h3>
    <p><strong>Vous êtes connecté.</strong></p>
    <button onclick="logout()">Déconnexion</button>
  </div>

  <!-- SCRIPT FINAL -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialisation Supabase
      const supabaseUrl = 'https://qytrcfwmsnlpdsdybcwo.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5dHJjZndtc25scGRzZHliY3dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjE5ODIsImV4cCI6MjA2NzMzNzk4Mn0.VGLI9SmCg6bNDUAVu3tgZjoejtiQRlAk6ufClWD_4SM';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // Afficher formulaire Connexion
      window.showLogin = function () {
        clearMessages();
        document.getElementById('login-register-container').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
      }

      // Afficher formulaire Enregistrement
      window.showRegister = function () {
        clearMessages();
        document.getElementById('login-register-container').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
      }

      // Retour au menu
      window.backToMenu = function () {
        clearMessages();
        document.getElementById('login-register-container').style.display = 'block';
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('dashboard').style.display = 'none';
      }

      // Nettoyer les messages d'erreur
      function clearMessages() {
        document.getElementById('login-message').innerText = '';
        document.getElementById('register-message').innerText = '';
      }

      // Connexion
      window.login = async function () {
        clearMessages();
        const id = document.getElementById('login-id').value.trim().toLowerCase();
        const password = document.getElementById('login-password').value;

        if (!id || !password) {
          document.getElementById('login-message').innerText = 'Veuillez remplir tous les champs.';
          return;
        }

        const { data, error } = await supabase
          .from('mot_de_passe')
          .select('ID, Password')
          .ilike('ID', id);

        if (error || !data || data.length === 0) {
          document.getElementById('login-message').innerText = 'Identifiant ou mot de passe incorrect.';
          return;
        }

        const user = data[0]; // On prend le premier résultat
        if (user.Password === password) {
          window.location.href = `https://myly95.github.io/Sukari/dashboard.html?id=${encodeURIComponent(user.ID)}`;
          document.getElementById('user-id-display').innerText = user.ID;
          document.getElementById('login-form').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
        } else {
          document.getElementById('login-message').innerText = 'Mot de passe incorrect.';
        }
      }

      // Enregistrement / Mise à jour
      window.register = async function () {
        clearMessages();
        const id = document.getElementById('register-id').value.trim().toLowerCase();
        const password = document.getElementById('register-password').value;

        if (!id || !password) {
          document.getElementById('register-message').innerText = 'Veuillez remplir tous les champs.';
          return;
        }

        try {
          const { data: existing, error: searchError } = await supabase
            .from('mot_de_passe')
            .select('ID')
            .ilike('ID', id);

          if (searchError) {
            document.getElementById('register-message').innerText = 'Erreur serveur, veuillez réessayer.';
            return;
          }

          if (existing.length > 0) {
            const { error: updateError } = await supabase
              .from('mot_de_passe')
              .update({ Password: password })
              .eq('ID', existing[0].ID);

            if (updateError) {
              document.getElementById('register-message').innerText = 'Erreur lors de la mise à jour.';
              return;
            }

            document.getElementById('register-message').className = 'success';
            document.getElementById('register-message').innerText = 'Mot de passe mis à jour avec succès.';
          } else {
            const { error: insertError } = await supabase
              .from('mot_de_passe')
              .insert([{ ID: id, Password: password }]);

            if (insertError) {
              document.getElementById('register-message').innerText = 'Erreur lors de la création du compte.';
              return;
            }

            document.getElementById('register-message').className = 'success';
            document.getElementById('register-message').innerText = 'Compte créé avec succès.';
          }

          setTimeout(() => {
            backToMenu();
            clearMessages();
            document.getElementById('register-id').value = '';
            document.getElementById('register-password').value = '';
          }, 2000);
        } catch (error) {
          console.error('Erreur globale:', error);
          document.getElementById('register-message').innerText = 'Erreur inattendue.';
        }
      }

      // Déconnexion
      window.logout = function () {
        backToMenu();
        document.getElementById('login-id').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('user-id-display').innerText = '';
      }
    });
  </script>
</body>
</html>
